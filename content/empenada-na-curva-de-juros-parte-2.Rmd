Title: Nada é tão ruim que não possa piorar: Empenada na Curva de Juros de DI1 — Parte 2
Category: finance
Author: Wilson Freitas
Tags: R, bizdays, term structure, interpolation
Date: 2015-09-23
Lang: pt
Description: Uma nova empenada na Curva de Juros de DI1 após o nome do deputado Eduardo Cunha aparecer na lista de acusados da Operação Lava Jato.

```{r, echo=FALSE}
hook_plot <- knit_hooks$get('plot')
knit_hooks$set(plot=function(x, options) {
    if (!is.null(options$pelican.publish) && options$pelican.publish) {
        x <- paste0("{filename}", x)
    }
    hook_plot(x, options)
})
opts_chunk$set(pelican.publish=TRUE)
```

```{r, message=FALSE, echo=FALSE}
library(XML)
library(bizdays)

cal <- Calendar(holidaysANBIMA, weekdays=c('saturday', 'sunday'), dib=252, name='ANBIMA')
bizdays.options$set(default.calendar=cal)

str_supplant <- function (string, repl) {
	result <- str_match_all(string, "\\{([^{}]*)\\}")
	if (length(result[[1]]) == 0)
		return(string)
	result <- result[[1]]
	for (i in seq_len(dim(result)[1])) {
		x <- result[i,]
		pattern <- x[1]
		key <- x[2]
		if (!is.null(repl[[key]]))
			string <- gsub(pattern, repl[[key]], string, perl=TRUE)
	}
	string
}

.get_curve_url <- function(refdate, ticker) {
	url <- 'http://www2.bmf.com.br/pages/portal/bmfbovespa/boletim1/TxRef1.asp'
	query <- str_supplant('?Data={refdate}&Data1={sysdate}&slcTaxa={ticker}',
		list(refdate=format(as.Date(refdate), '%d/%m/%Y'),
			sysdate=format(Sys.Date(), '%Y%m%d'),
			ticker=ticker))
	paste0(url, query)
}

get_curve <- function (refdate, ticker='PRE') {
	refdate <- as.Date(refdate)
	url <- .get_curve_url(refdate, ticker)
	doc <- htmlTreeParse(url, useInternalNodes=TRUE)
	num <- xpathSApply(doc, "//td[contains(@class, 'tabelaConteudo')]", 
		function(x) gsub('[\r\n \t]+', '', xmlValue(x)))
	num <- sapply(num, function(x) as.numeric(gsub(',', '.', x)), USE.NAMES=FALSE)

	colspan <- as.integer(xpathApply(doc, "//td[contains(@class, 'tabelaTitulo')]",  xmlAttrs )[[2]][3])
	if (colspan == 1) {
		terms <- num[c(TRUE, FALSE)]
		rates <- num[c(FALSE, TRUE)]/100
		log_pu <- log(1 + rates*terms/360)
		rate <- function(pu, term) (pu - 1)*(360/term)
	} else {
		terms <- bizdayse(refdate, num[c(TRUE, FALSE, FALSE)])
		rates <- num[c(FALSE, TRUE, FALSE)]/100
		log_pu <- log((1 + rates)^(terms/252))
		rate <- function(pu, term) pu^(252/term) - 1
	}

	log_price_interpolator <- approxfun(terms, log_pu, method='linear')
	function (term) {
		pu <- exp(log_price_interpolator(term))
		rate(pu, term)*100
	}
}
```

[bmf]: http://www.bmfbovespa.com.br/home.aspx?idioma=pt-br "BM&F Bovespa"
[bmf-curves]: http://www2.bmf.com.br/pages/portal/bmfbovespa/boletim1/TxRef1.asp "BVMF Curves"

O mês de setembro de 2015 não está sendo fácil para o mercado financeiro.
Alta de dólar (rompeu a barreira de R$ 4,00 e segue sem rumo), disparada de juros, pacote bomba do governo, pacote fiscal nebuloso, volta da CPMF e por aí vai.
Mas no dia 23 de setembro de 2015 aconteceu algo interessante, após o nome do deputado Eduardo Cunha aparecer na lista de acusados da Operação Lava Jato, a curva de juros deu uma nova empenada.
Essa empenada é reflexo da incerteza que ronda a aprovação de medidas importantes para a economia e para o país, incluindo o corte de gastos e o ajuste fiscal.
Olhe no gráfico abaixo a curva de juros de DI1 para a semana do dia 21 de setembro.

```{r many-di1-term-structure-plot-2, fig.width=15, fig.cap="Brazilian Term Structure", warning=FALSE, message=FALSE}
seq(21, 1260, by=21) -> terms

dates <- seq(as.Date('2015-09-21'), as.Date('2015-09-23'), by='days')
curves <- lapply(dates, function(d) {
	get_curve(d, 'PRE')(terms)
})
names(curves) <- dates

ir_df <- stack(curves)
ir_df$date <- terms + Sys.Date()

library(ggplot2)
ggplot(data=ir_df, aes(x=date, y=values, colour=ind)) + geom_point() + geom_line() +
  xlab('Datas') + ylab('Taxas') + theme(legend.title=element_blank(), legend.position='top') + ggtitle('Curvas de DI1')
```

Isso mesmo, em 3 dias a curva deu uma empenada de 1 ponto percentual (100 basis points (bps)).

> os códigos da função `get_curve` estão no post [Empenada na Curva de Juros de DI1]({filename}empenada-na-curva-de-juros.Rmd)